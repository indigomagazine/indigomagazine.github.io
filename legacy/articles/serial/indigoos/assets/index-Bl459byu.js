var N=Object.defineProperty;var j=(e,t,r)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var c=(e,t,r)=>(j(e,typeof t!="symbol"?t+"":t,r),r);function I(e){const t={d:{}};for(const r of Object.keys(e)){const n=e[r];if("file"in n){const a=n.file.contents,i=typeof a=="string"?a:H(a),o=typeof a=="string"?{}:{b:!0};t.d[r]={f:{c:i,...o}};continue}const s=I(n.directory);t.d[r]=s}return t}function H(e){let t="";for(const r of e)t+=String.fromCharCode(r);return t}var V=Object.defineProperty,q=(e,t)=>{for(var r in t)V(e,r,{get:t[r],enumerable:!0})},h={};q(h,{createEndpoint:()=>M,expose:()=>L,proxy:()=>W,proxyMarker:()=>k,releaseProxy:()=>F,transfer:()=>U,transferHandlers:()=>S,windowEndpoint:()=>J,wrap:()=>T});var k=Symbol("Comlink.proxy"),M=Symbol("Comlink.endpoint"),F=Symbol("Comlink.releaseProxy"),P=Symbol("Comlink.thrown"),R=e=>typeof e=="object"&&e!==null||typeof e=="function",B={canHandle:e=>R(e)&&e[k],serialize(e){const{port1:t,port2:r}=new MessageChannel;return L(e,t),[r,[r]]},deserialize(e){return e.start(),T(e)}},Y={canHandle:e=>R(e)&&P in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},S=new Map([["proxy",B],["throw",Y]]);function L(e,t=self){t.addEventListener("message",function r(n){if(!n||!n.data)return;const{id:s,type:a,path:i}=Object.assign({path:[]},n.data),o=(n.data.argumentList||[]).map(w);let l;try{const u=i.slice(0,-1).reduce((f,_)=>f[_],e),d=i.reduce((f,_)=>f[_],e);switch(a){case 0:l=d;break;case 1:u[i.slice(-1)[0]]=w(n.data.value),l=!0;break;case 2:l=d.apply(u,o);break;case 3:{const f=new d(...o);l=W(f)}break;case 4:{const{port1:f,port2:_}=new MessageChannel;L(e,_),l=U(f,[f])}break;case 5:l=void 0;break}}catch(u){l={value:u,[P]:0}}Promise.resolve(l).catch(u=>({value:u,[P]:0})).then(u=>{const[d,f]=A(u);t.postMessage(Object.assign(Object.assign({},d),{id:s}),f),a===5&&(t.removeEventListener("message",r),O(t))})}),t.start&&t.start()}function $(e){return e.constructor.name==="MessagePort"}function O(e){$(e)&&e.close()}function T(e,t){return x(e,[],t)}function p(e){if(e)throw new Error("Proxy has been released and is not useable")}function x(e,t=[],r=function(){}){let n=!1;const s=new Proxy(r,{get(a,i){if(p(n),i===F)return()=>m(e,{type:5,path:t.map(o=>o.toString())}).then(()=>{O(e),n=!0});if(i==="then"){if(t.length===0)return{then:()=>s};const o=m(e,{type:0,path:t.map(l=>l.toString())}).then(w);return o.then.bind(o)}return x(e,[...t,i])},set(a,i,o){p(n);const[l,u]=A(o);return m(e,{type:1,path:[...t,i].map(d=>d.toString()),value:l},u).then(w)},apply(a,i,o){p(n);const l=t[t.length-1];if(l===M)return m(e,{type:4}).then(w);if(l==="bind")return x(e,t.slice(0,-1));const[u,d]=C(o);return m(e,{type:2,path:t.map(f=>f.toString()),argumentList:u},d).then(w)},construct(a,i){p(n);const[o,l]=C(i);return m(e,{type:3,path:t.map(u=>u.toString()),argumentList:o},l).then(w)}});return s}function G(e){return Array.prototype.concat.apply([],e)}function C(e){const t=e.map(A);return[t.map(r=>r[0]),G(t.map(r=>r[1]))]}var D=new WeakMap;function U(e,t){return D.set(e,t),e}function W(e){return Object.assign(e,{[k]:!0})}function J(e,t=self,r="*"){return{postMessage:(n,s)=>e.postMessage(n,r,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function A(e){for(const[t,r]of S)if(r.canHandle(e)){const[n,s]=r.serialize(e);return[{type:3,name:t,value:n},s]}return[{type:0,value:e},D.get(e)||[]]}function w(e){switch(e.type){case 3:return S.get(e.name).deserialize(e.value);case 0:return e.value}}function m(e,t,r){return new Promise(n=>{const s=X();e.addEventListener("message",function a(i){!i.data||!i.data.id||i.data.id!==s||(e.removeEventListener("message",a),n(i.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),r)})}function X(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const K="https://stackblitz.com/headless";let g=null,b=null,E={};const Q=new TextDecoder,Z=new TextEncoder,y=class y{constructor(t,r,n){c(this,"_instance");c(this,"_runtimeInfo");c(this,"fs");c(this,"_tornDown",!1);this._instance=t,this._runtimeInfo=n,this.fs=new ie(r)}async spawn(t,r,n){let s=[];Array.isArray(r)?s=r:n=r;let a,i=new ReadableStream;if((n==null?void 0:n.output)!==!1){const u=he();a=u.push,i=u.stream}const o=z(oe(a)),l=await this._instance.run({command:t,args:s,env:n==null?void 0:n.env,terminal:n==null?void 0:n.terminal},void 0,void 0,o);return new se(l,i)}on(t,r){let n=!1,s=()=>{};const a=(...i)=>{n||r(...i)};return this._instance.on(t,h.proxy(a)).then(i=>{s=i,n&&s()}),()=>{n=!0,s()}}mount(t,r){const n=t instanceof Uint8Array?t:Z.encode(JSON.stringify(I(t)));return this._instance.loadFiles(h.transfer(n,[n.buffer]),{mountPoints:r==null?void 0:r.mountPoint})}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this.fs._teardown(),this._instance.teardown(),this._instance[h.releaseProxy](),y._instance===this&&(y._instance=null)}static async boot(t={}){const{workdirName:r}=t;if(window.crossOriginIsolated&&t.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),r!=null&&r.includes("/")||r===".."||r===".")throw new Error("workdirName should be a valid folder name");for(;g;)await g;if(y._instance)throw new Error("Only a single WebContainer instance can be booted");const n=ae(t);g=n.catch(()=>{});try{const s=await n;return y._instance=s,s}finally{g=null}}};c(y,"_instance",null);let v=y;const ee=1,te=2;class re{constructor(t,r){c(this,"name");c(this,"_type");this.name=t,this._type=r}isFile(){return this._type===ee}isDirectory(){return this._type===te}}class ne{constructor(t,r,n,s){c(this,"_apiClient");c(this,"_path");c(this,"_options");c(this,"_listener");c(this,"_wrappedListener");c(this,"_watcher");c(this,"_closed",!1);this._apiClient=t,this._path=r,this._options=n,this._listener=s,this._apiClient._watchers.add(this),this._wrappedListener=(a,i)=>{this._listener&&!this._closed&&this._listener(a,i)},this._apiClient._fs.watch(this._path,this._options,z(this._wrappedListener)).then(a=>{this._watcher=a,this._closed&&this._teardown()}).catch(console.error)}close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),this._teardown())}_teardown(){var t;(t=this._watcher)==null||t.close().finally(()=>{var r;(r=this._watcher)==null||r[h.releaseProxy]()})}}class se{constructor(t,r){c(this,"output");c(this,"input");c(this,"exit");c(this,"_process");this.output=r,this._process=t,this.input=new WritableStream({write:n=>{var s;(s=this._getProcess())==null||s.write(n).catch(()=>{})}}),this.exit=this._onExit()}kill(){var t;(t=this._getProcess())==null||t.kill()}resize(t){var r;(r=this._getProcess())==null||r.resize(t)}async _onExit(){var t;try{return await this._process.onExit}finally{(t=this._process)==null||t[h.releaseProxy](),this._process=null}}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}}class ie{constructor(t){c(this,"_fs");c(this,"_watchers",new Set([]));this._fs=t}rm(...t){return this._fs.rm(...t)}async readFile(t,r){return await this._fs.readFile(t,r)}async rename(t,r){return await this._fs.rename(t,r)}async writeFile(t,r,n){if(r instanceof Uint8Array){const s=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);r=h.transfer(new Uint8Array(s),[s])}await this._fs.writeFile(t,r,n)}async readdir(t,r){const n=await this._fs.readdir(t,r);return le(n)||ue(n)?n:n.map(a=>new re(a.name,a["Symbol(type)"]))}async mkdir(t,r){return await this._fs.mkdir(t,r)}watch(t,r,n){return typeof r=="function"&&(n=r,r=null),new ne(this,t,r,n)}_teardown(){this._fs[h.releaseProxy]();for(const t of this._watchers)t.close()}}async function ae(e){const{serverPromise:t}=ce(e),n=await(await t).build({host:window.location.host,version:"1.1.8",workdirName:e.workdirName}),s=await n.fs(),a=await n.runtimeInfo();return new v(n,s,a)}function oe(e){if(e!=null)return t=>{t instanceof Uint8Array?e(Q.decode(t)):t==null&&e(null)}}function z(e){if(e!=null)return h.proxy(e)}function ce(e){if(b!=null)return e.coep!==E.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${e.coep}'`),console.warn(`First boot had 'coep: ${E.coep}', new settings will not take effect!`)),{serverPromise:b};const t=document.createElement("iframe");t.style.display="none",t.setAttribute("allow","cross-origin-isolated");const r=fe();r.searchParams.set("version","1.1.8"),e.coep&&r.searchParams.set("coep",e.coep),t.src=r.toString();const{origin:n}=r;return E={...e},b=new Promise(s=>{const a=i=>{if(i.origin!==n)return;const{data:o}=i;if(o.type==="init"){s(h.wrap(i.ports[0]));return}if(o.type==="warning"){console[o.level].call(console,o.message);return}};window.addEventListener("message",a)}),document.body.insertBefore(t,null),{serverPromise:b}}function le(e){return typeof e[0]=="string"}function ue(e){return e[0]instanceof Uint8Array}function fe(){return new URL(window.WEBCONTAINER_API_IFRAME_URL??K)}function he(){let e=null;return{stream:new ReadableStream({start(n){e=n}}),push:n=>{n!=null?e==null||e.enqueue(n):(e==null||e.close(),e=null)}}}export{v as WebContainer};
