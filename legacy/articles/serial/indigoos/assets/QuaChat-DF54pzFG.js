var v=Object.defineProperty;var S=(a,e,t)=>e in a?v(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var s=(a,e,t)=>(S(a,typeof e!="symbol"?e+"":e,t),t);import{r as h,j as l}from"./index-BWmU0So1.js";class x{constructor(e,t,n){s(this,"version");s(this,"packetType");s(this,"length");this.version=e,this.packetType=t,this.length=n}}class i{constructor(e,t){s(this,"header");s(this,"payload");this.header=e,this.payload=t}static newPacket(e,t){return new i(new x(1,e,t.length),t)}static fromBytes(e){const t=new DataView(e);let n=0;const o=t.getUint8(n);n+=1;const w=t.getUint8(n);n+=1;const f=t.getUint16(n,!1);n+=2;const r=new Uint8Array(e,n,f),u=new x(o,w,f);return new i(u,r)}toBinary(){const e=new ArrayBuffer(4+this.payload.length),t=new DataView(e);let n=0;return t.setUint8(n,this.header.version),n+=1,t.setUint8(n,this.header.packetType),n+=1,t.setUint16(n,this.header.length,!1),n+=2,new Uint8Array(e,n,this.payload.length).set(this.payload),e}}class P{constructor(e,t){s(this,"id");s(this,"name");this.id=e,this.name=t}}class m{constructor(e,t,n,o){s(this,"id");s(this,"is_server");s(this,"room");s(this,"author");s(this,"content");s(this,"created_at");s(this,"is_command");this.id=this.generateId(),this.author=e,this.content=t,this.created_at=o,this.room=n,this.is_command=!1,this.is_server=!1}generateId(){return Math.random().toString(36).substring(2,15)}static newServerMessage(e,t,n){const o=new m({id:"SERVER",username:"SERVER"},e,t,n);return o.is_server=!0,o}static newCommandMessage(e,t){const n=new P("COMMAND_RESPONSE","Command Response"),o=new m({id:"COMMAND",username:"COMMAND"},e,n,t);return o.is_command=!0,o}static fromPacket(e){const t=new TextDecoder().decode(e.payload),n=JSON.parse(t);return new m(n.author,n.content,new P(n.room.id,n.room.name),new Date(n.created_at))}toPacket(){const e=new TextEncoder().encode(JSON.stringify(this));return i.newPacket(1,e)}}class g{constructor(e,t){s(this,"username");s(this,"roomId");this.username=e,this.roomId=t}static fromPacket(e){const t=new TextDecoder().decode(e.payload),n=JSON.parse(t);return new g(n.username,n.roomId)}toPacket(){const e=new TextEncoder().encode(JSON.stringify(this));return i.newPacket(0,e)}}class k{constructor(e,t,n,o){s(this,"status");s(this,"content");s(this,"roomId");s(this,"account");this.status=e,this.content=t,this.roomId=n,this.account=o}static fromPacket(e){const t=new TextDecoder().decode(e.payload),n=JSON.parse(t);return new k(n.status,n.content,n.roomId,n.account)}toPacket(){const e=new TextEncoder().encode(JSON.stringify(this));return i.newPacket(0,e)}}class p{constructor(){}static fromPacket(e){return new p}toPacket(){const e=new TextEncoder().encode(JSON.stringify(this));return i.newPacket(2,e)}}class b{constructor(e){s(this,"socket");s(this,"account");this.addr=e}connect(){return new Promise(e=>{const t=new WebSocket(this.addr);t.binaryType="arraybuffer",this.socket=t,t.onopen=()=>{e(!0)}})}async ping(){return this.sendPacket(new p().toPacket())}async auth(e){await this.sendPacket(new g(e).toPacket());const t=k.fromPacket(await this.readPacket());return t.status!=="ok"?(console.log("failed to login"),null):(this.account=t.account,this.account??null)}async sendPacket(e){this.send(e.toBinary())}onMessage(e){this.socket&&(this.socket.onmessage=t=>{const n=i.fromBytes(t.data);e(m.fromPacket(n))})}async readPacket(){const e=await await this.read();return i.fromBytes(e)}send(e){var t;(t=this.socket)==null||t.send(e)}read(){return new Promise((e,t)=>{if(!this.socket)return t(new Error("Socket is not initialized"));this.socket.onmessage=n=>{e(n.data)},this.socket.onerror=n=>{t(n)}})}close(){var e;(e=this.socket)==null||e.close()}}function T(){const a=h.useRef(null),e=h.useRef(null),t=h.useRef(null),n=h.useRef(null),[o,w]=h.useState([]);h.useEffect(()=>{if(t.current!=null)return;async function r(){t.current=new b("wss://chat.jnaraujo.com/lc"),await t.current.connect(),n.current=await t.current.auth("Quack"),t.current.onMessage(c=>{w(d=>[...d,c]),setTimeout(()=>{var y;const d=e.current;d&&d.scrollHeight-d.scrollTop<d.clientHeight+200&&((y=a.current)==null||y.scrollIntoView({behavior:"smooth",block:"end"}))},10)})}r();const u=setInterval(()=>{var c;(c=t.current)==null||c.ping()},3e4);return()=>{var c;(c=t.current)==null||c.close(),t.current=null,clearInterval(u)}},[]);async function f(r){if(r.preventDefault(),!t.current||!n.current)return;const u=r.currentTarget.elements.content.value;r.currentTarget.elements.content.value="",await t.current.sendPacket(new m(n.current,u,{id:"ALL",name:""},new Date(Date.now())).toPacket())}return l.jsxs("div",{className:"flex flex-1 flex-col justify-between antialiased",children:[l.jsxs("div",{ref:e,className:"flex-1 overflow-y-auto",children:[o.map(r=>{var u,c;return l.jsxs("div",{children:["[",r.created_at.toLocaleString("en-us",{hour:"numeric",minute:"numeric",hour12:!0}),"] [",r.room.name,"] ","<",(u=r.author)==null?void 0:u.id.slice(0,6),">"," ",(c=r.author)==null?void 0:c.username,": ",r.content," "]},r.id)}),l.jsx("div",{ref:a})]}),l.jsxs("form",{className:"flex gap-1",onSubmit:f,children:[l.jsx("input",{name:"content",className:"flex-1 border border-black"}),l.jsx("button",{style:{backgroundImage:"url('icons/arrows/arrow/left.svg')"},className:"mr-1 h-6 w-6 -scale-x-100 bg-contain bg-center bg-no-repeat active:shadow-[inset_-1px_-1px_6px_0px_rgba(0,0,0,0.4)]"})]})]})}export{T as default};
